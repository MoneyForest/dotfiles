---
name: structured-dialogue
description: Detailed guide for structured dialogue with question templates, design patterns, and practical examples. Use when applying AI-DLC workflow for complex problem-solving.
---

# Structured Dialogue Skill

このスキルは、AI-Driven Workflow の詳細ガイドです。複雑な問題解決で構造化された対話を行う際に使用します。

## 📋 質問の設計フレームワーク

### 情報収集の5つのカテゴリ

すべての重要なタスクで、以下の情報を収集する：

| カテゴリ | 目的 | 質問例 |
|----------|---------|--------|
| **定量的情報** | 規模、メトリクス、トレンド | "現在の負荷は？ 成長率は？ 目標メトリクスは？" |
| **定性的情報** | ステークホルダー、コンテキスト、優先度 | "誰が影響を受ける？ 何が最重要？" |
| **リスク** | インパクト、発生確率、緩和策 | "最悪のケースは？ 確率は？ 防止策は？" |
| **リソース** | 予算、時間、チーム | "利用可能なリソースは？ タイムライン？ チーム規模？" |
| **プロセス** | 承認、エスカレーション、コミュニケーション | "誰が承認？ 緊急時は？ 誰に通知？" |

---

## 🎯 コンテキスト別質問テンプレート

### 1. 新機能開発（New Feature Development）

```markdown
[AskUserQuestion ツールを使用]

質問1: この機能の主なビジネス価値は？
選択肢:
A) 収益増加（新しい収益源を可能にする）
B) ユーザー体験改善（摩擦を減らし、メトリクスを改善）
C) 運用コスト削減（自動化、効率化）
D) 競争優位性（ユニークな機能）

質問2: 主要ユーザーは誰ですか？
選択肢:
A) エンドユーザー（B2C）
B) ビジネス顧客（B2B）
C) 社内チーム（運用、サポート）
D) 複数のペルソナ（説明してください）

質問3: 成功をどう測定しますか？
選択肢:
A) ユーザーエンゲージメント指標（DAU、リテンション等）
B) ビジネス指標（コンバージョン、収益等）
C) 技術指標（パフォーマンス、信頼性等）
D) 組み合わせ（説明してください）

質問4: 主な制約は？
選択肢:
A) 市場投入までの時間（競争圧力）
B) 予算制限
C) 技術的制限（インフラ、依存関係）
D) チーム規模
```

### 2. バグ修正（Bug Fix）

```markdown
[AskUserQuestion ツールを使用]

質問1: ビジネスインパクトは？
選択肢:
A) 軽微（表示上の問題、低トラフィックエリア）
B) 中程度（一部ユーザーに影響、回避策あり）
C) 重大（多数のユーザーに影響、回避策なし）
D) クリティカル（サービス停止、収益損失、評判への影響）

質問2: 修正アプローチは？
選択肢:
A) クイックフィックス（最小限の変更、速いデプロイ）
B) 根本原因の修正（深い変更、類似問題の防止）
C) 回避策 + 根本原因（段階的アプローチ）

質問3: テスト戦略は？
選択肢:
A) ユニットテストのみ
B) 統合テスト
C) E2Eテスト
D) 本番検証（カナリア、段階的ロールアウト）

質問4: 緊急度は？
選択肢:
A) 緊急（即座のホットフィックス必要）
B) 急ぎ（次のリリースで修正）
C) 通常（通常のスプリントに含める）
```

### 3. パフォーマンス改善（Performance Improvement）

```markdown
[AskUserQuestion ツールを使用]

質問1: 現在のパフォーマンスベースラインは？
選択肢:
A) 具体的なメトリクスあり（P50/P95/P99レイテンシ、スループット）
B) ユーザーからの苦情（定性的フィードバック）
C) SLOとの比較（ターゲット未達）
D) 不明、調査が必要

質問2: パフォーマンス目標は？
選択肢:
A) SLOを満たす（具体的なターゲット: [X]ms、[Y] RPS）
B) 競合のパフォーマンスに合わせる
C) パーセンテージで改善（[X]%速く）
D) "十分に良い"（ユーザー満足、具体的な数値なし）

質問3: ボトルネックの仮説は？
選択肢:
A) データベースクエリ
B) 外部API呼び出し
C) CPU集約的な計算
D) ネットワークI/O
E) 不明、プロファイリングが必要

質問4: ビジネスクリティカル度は？
選択肢:
A) クリティカル（コアKPI、ユーザーリテンションに影響）
B) 高（ユーザー体験にとって重要）
C) 中（あればよい、緊急ではない）
```

### 4. インシデント対応とポストモーテム

```markdown
[AskUserQuestion ツールを使用]

質問1: インシデントの影響範囲は？
選択肢:
A) 特定の負荷パターン（ピーク時）に限定
B) 特定のユーザー/セグメントに限定
C) サービス全体（全ユーザーに影響）
D) 不明（調査が必要）

質問2: 今後の成長トレンドは？
選択肢:
A) 予測可能（履歴データあり、季節パターン既知）
B) 安定成長だが不確実性あり（一般的なトレンド、具体的な数値なし）
C) 予測不可能（大口顧客獲得の可能性、市場変化）
D) 不明（調査が必要）

質問3: 対応計画に関与すべきステークホルダーは？（複数選択可）
選択肢:
A) インフラ/プラットフォームチーム
B) プロダクト/ビジネスチーム
C) 経営層
D) カスタマーサポート/オペレーション
E) その他のチーム

質問4: 予防策の最大の制約は？
選択肢:
A) 予算（インフラ支出の制限）
B) 期限までの時間（繁忙期が近い）
C) チーム規模（エンジニアリングリソースの制限）
D) 予測不可能性（負荷予測困難、ビジネス成長不透明）
E) その他（説明してください）

質問5: 許容可能なリスクレベルは？
選択肢:
A) ゼロトレランス（ミッションクリティカル、評判がかかっている）
B) 低トレランス（短時間の劣化は許容、停止は不可）
C) 中程度のトレランス（許容可能なダウンタイムウィンドウあり）
```

### 5. アーキテクチャ決定（Architecture Decision）

```markdown
[AskUserQuestion ツールを使用]

質問1: どのような種類のアーキテクチャ決定ですか？
選択肢:
A) 技術選定（フレームワーク、データベース、クラウドサービス）
B) 設計パターン（アーキテクチャスタイル、通信パターン）
C) インフラ（スケーリング戦略、デプロイモデル）
D) セキュリティ/コンプライアンス（認証、データ保護）

質問2: サポートすべき規模は？
選択肢:
A) 現在の規模のみ（今のために最適化）
B) 既知の将来規模（[X]倍の成長を想定）
C) 不明な将来規模（柔軟性のために設計）

質問3: トレードオフの優先順位は？
選択肢:
A) パフォーマンス（レイテンシ、スループット）
B) コスト（インフラ、ライセンス、運用）
C) 開発速度（開発のしやすさ、市場投入までの時間）
D) 信頼性（稼働率、耐障害性）
E) セキュリティ（データ保護、コンプライアンス）

質問4: この決定の可逆性は？
選択肢:
A) 変更困難（長期間コミット）
B) 中程度の可逆性（必要なら移行可能だが労力要）
C) 容易に可逆（選択肢性のために設計、抽象化）
```

### 6. リファクタリング

```markdown
[AskUserQuestion ツールを使用]

質問1: 主な目的は？
選択肢:
A) 可読性/保守性の向上
B) パフォーマンスの向上
C) テスタビリティの向上
D) 技術的負債の削減
E) 将来機能の準備（拡張性の実現）

質問2: ビジネス価値は？
選択肢:
A) 将来の機能実装時間を削減
B) 運用コストを削減（バグ、インシデントの減少）
C) 新しいビジネス機能を可能にする
D) 直接的なビジネス価値なし（純粋に技術的改善）

質問3: 変更の範囲は？
選択肢:
A) 単一ファイル/モジュール
B) サービス内の複数ファイル
C) 複数サービス（API変更、データモデル変更）

質問4: リスクレベルは？
選択肢:
A) 低リスク（内部変更のみ、十分にテスト済み）
B) 中リスク（一部API変更、移行パス明確）
C) 高リスク（大きな変更、バグの可能性）

質問5: 互換性要件は？
選択肢:
A) 完全な後方互換性が必要
B) 破壊的変更が許容される（ステークホルダーと調整）
C) 段階的移行（新旧両方のAPIが共存）
```

---

## 💼 ビジネス価値の紐付け

### ユーザーストーリー駆動アプローチ

**常に複数の視点からユーザーストーリーを作成する：**

```markdown
### ユーザーストーリー

**Story 1（エンドユーザー - B2C）:**
As a [プラットフォームユーザー], I need [機能] so that [目標達成]
→ ビジネス価値: [コアKPIへの影響]

**Story 2（ビジネス顧客 - B2B）:**
As a [ビジネス顧客], I need [機能] so that [目標達成]
→ ビジネス価値: [収益/リテンションへの影響]

**Story 3（社内チーム）:**
As a [チームメンバー], I need [機能] so that [運用上の利益]
→ ビジネス価値: [効率性/信頼性への影響]

**Story 4（経営層）:**
As a [ステークホルダー], I need [機能] so that [戦略目標]
→ ビジネス価値: [成長/競争優位]
```

### 技術タスクとビジネス成果のリンク

**悪い例（技術的焦点のみ）:**
```
- CPU使用率アラートを設定
- レート制限を実装
- キャッシュレイヤーを追加
```

**良い例（ビジネス価値が明確）:**
```
- 段階的CPUアラート（60%/70%/80%）を設定
  → ビジネス価値: 早期警告により障害前に対応、[コアKPI]を[X]%で維持

- アダプティブなレート制限を実装
  → ビジネス価値: 予測不可能な成長時にプラットフォームの安定性を保護、
     顧客離脱を防止

- TTL戦略でキャッシュを追加
  → ビジネス価値: レスポンス時間を[X]%削減、
     ユーザー体験とコンバージョン率を向上
```

---

## 🎨 実践から学んだ設計パターン

### 1. 三層防御パターン（Three-Layer Defense）

**クリティカルシステムでは、多層防御を実装：**

```markdown
### Layer 1: 予防（問題が発生する前に阻止）
- 最悪ケースに基づくキャパシティプランニング
- レート制限とトラフィック整形
- 入力検証とサニタイゼーション
- 段階的ロールアウト（カナリア、ブルーグリーン）

→ ビジネス価値: プロアクティブな安定性、インシデント頻度の削減

### Layer 2: 検知（問題発生時に即座に把握）
- 段階的アラート（60% → 70% → 80% 閾値）
- 異常検知と予測
- ユーザー向けモニタリング（合成チェック）
- ビジネスメトリクスモニタリング（コンバージョン、エンゲージメント）

→ ビジネス価値: 早期警告により迅速対応、ユーザー影響を最小化

### Layer 3: 緩和（問題発生時に影響を最小化）
- オートスケーリングポリシー
- サーキットブレーカーと縮退運転
- ランブック自動化（自己修復）
- 明確なエスカレーションパス（< 30分対応時間）

→ ビジネス価値: MTTR削減、サービス可用性維持
```

**実例:**
> 予測不可能な負荷を経験する重要なインフラコンポーネントの場合:
> - **予防**: ピーク負荷を平準化するレート制限
> - **検知**: トレンド分析付き多段階アラート（60/70/80%）
> - **緩和**: オートスケーリング手順 + コア機能を維持する縮退運転

### 2. 段階的実装パターン（Phased Implementation）

**不確実性に直面した場合、明示的な学習目標を持つフェーズに分割：**

```markdown
### Phase 1: 基盤（Week 1-2）
**目標**: 可観測性と早期警告を確立
**タスク**:
- [ ] 強化された監視とダッシュボード
- [ ] 段階的アラート閾値
- [ ] 現在のベースラインパフォーマンスを文書化

**ビジネス成果**: システムヘルスの可視性、早期検知への自信
**決定ポイント**: 問題を早期に検出するのに十分な可観測性か？

### Phase 2: 予防（Week 3-4）
**目標**: インシデントの発生確率を削減
**タスク**:
- [ ] レート制限の実装
- [ ] SLOターゲットの定義
- [ ] キャパシティプランニングモデル

**ビジネス成果**: インシデント確率の削減、予測可能な容量
**決定ポイント**: [今後のイベント]の予測容量に満足か？

### Phase 3: 検証（Week 5-6）
**目標**: 現実的な条件下での準備状況を検証
**タスク**:
- [ ] 負荷テスト（予想ピークの5倍）
- [ ] 障害シナリオテスト（カオスエンジニアリング）
- [ ] 経営層への準備状況レビュー

**ビジネス成果**: ピーク負荷への対処に自信、経営層の賛同
**決定ポイント**: [重要イベント]への準備は整ったか？
```

**重要な原則**: 各フェーズには明確なビジネス成果と決定ポイントがある。現在のフェーズが目標を達成したことを確認せずに次のフェーズに進まない。

### 3. 動的応答パターン（Dynamic Response）

**予測が難しい場合、高速対応を最適化：**

```markdown
### シナリオ: 予測不可能な成長パターン

**課題**:
- 履歴データが不十分
- 大口顧客獲得の可能性（タイミングと規模が予測不可能）
- ビジネス成長率が不確実

**従来のアプローチ（機能しない）:**
❌ 履歴データからピーク負荷を予測
❌ 予測に基づいて固定容量をプロビジョニング
❌ 四半期ごとのキャパシティプランニングサイクル

**動的応答アプローチ:**
✅ 現在のベースラインとマージンを確立
✅ 段階的オートスケーリング（自動+手動）を実装
✅ 30分スケールアップ対応のランブック作成
✅ ビジネスメトリクス相関を含む継続的モニタリング
✅ 週次キャパシティレビューのケイデンス

**ビジネス価値:**
- 遅延なく機会（大口顧客）に対応可能
- 過剰プロビジョニングなし（コスト効率）
- 不確実性にもかかわらず信頼性を維持
```

---

## 🔒 制約駆動設計の実例

### 例1: 不確実性が主な制約

**特定された制約:**
> "負荷予測が困難; ビジネス成長が予測不可能; 大口顧客獲得により突然のスパイクが発生する可能性"

**設計への影響:**
- ❌ 予測ベース: "Q2の負荷を予測してそれに応じてプロビジョニングしよう"
- ✅ 動的応答ベース: "あらゆる負荷パターンへの高速対応のために設計しよう"

**具体的な変更:**
1. 段階的オートスケーリングポリシー（70%、80%、90%でトリガー）
2. 30分SLAの手動スケーリングランブック
3. より大きなマージン（2倍ではなく5倍ピークでテスト）
4. 週次キャパシティレビュー（四半期ではなく）

### 例2: ビジネスクリティカル性が主な制約

**特定された制約:**
> "サービス障害はクリティカル: 評判への損害、信頼喪失、[コアKPI]への影響"

**設計への影響:**
- ❌ コスト最適化: "必要最小限で運用し、必要に応じてスケール"
- ✅ 信頼性優先: "余裕を持ってプロビジョニングし、多層防御"

**具体的な変更:**
1. 三層防御（予防 + 検知 + 緩和）
2. 縮退運転（支援機能が失敗してもコア機能は維持）
3. N+2冗長性（N+1ではなく）
4. 定期的な実践としてのカオスエンジニアリング

### 例3: リソース制約

**特定された制約:**
> "エンジニアリングチームの規模に制限; 期限まで[X]人日のみ利用可能"

**設計への影響:**
- ❌ 包括的ソリューション: "すべてを完璧に実装しよう"
- ✅ 段階的アプローチ: "高 → 中 → 低の優先順位付け、時間切れで停止"

**具体的な変更:**
1. 理由付きの明確な優先順位層（H/M/L）
2. Phase 1（必須） + Phase 2（推奨） + Phase 3（あればよい）
3. 各フェーズが独立したビジネス価値を提供
4. Phase 1後にリソースチェックポイント、Phase 2にコミットする前に

---

## 📊 合意形成の可視化

### Frozen Requirements（合意された事実）

**Phase 2のプラン提示時に明文化:**

```markdown
### Frozen Requirements（合意された事実）

**Phase 0-1の対話で確立された事実：**

- **ビジネスコンテキスト**: [主要ビジネスメトリクス、ステークホルダー、ユーザーペルソナ]
- **制約**: [主な制約、許容可能なトレードオフ]
- **成功の定義**: [成功とは何か]
- **失敗の定義**: [失敗とみなされるもの]
- **既存パターン**: [従うべきコードパターン、アーキテクチャ制約]

**注**: これらの frozen requirements への変更は、明示的な議論と再合意が必要。
```

### Latest Agreed State（最新の合意状態）

**Phase 3の実装中に継続的に更新:**

```markdown
### Latest Agreed State（各主要決定後に更新）

**最終更新**: [日時]

**Frozen Requirements ステータス**:
- ✅ ビジネスコンテキスト: [確認済み/更新済み]
- ✅ 制約: [確認済み/理由とともに更新済み]
- ⚠️ 成功基準: [Step X の知見に基づき調整]

**完了**:
- ✅ Phase 1, Step 1: [説明] → ビジネス価値: [達成した成果]
- ✅ Phase 1, Step 2: [説明] → ビジネス価値: [達成した成果]

**進行中**:
- 🚧 Phase 2, Step 1: [説明] → 完了予定: [タイムライン]

**保留中の決定**:
- ❓ [決定ポイント]: [ステークホルダー/情報]待ち
```

---

## ⚠️ ユーザー疲労への対応

### 疲労の兆候

**以下の兆候を監視:**
- 短く、焦った返答
- "ちょうどやって"、"いい感じに"（うまくやって/任せる）
- 提供された選択肢の代わりに「その他」を繰り返し選択

### ショートカットモードへの切り替え

**疲労を検知したら:**

1. **認識**: "これが重くなってきていると感じます。シンプルにします。"
2. **ショートカットモードに移行**: コンテキストに基づいて合理的な仮定を立てる
3. **仮定を明示**: "仮定 X、Y、Z で進めます。間違っていれば訂正してください。"
4. **すばやく価値を提供**: その後、フィードバックに基づいて反復

### 質の高い質問の維持

**質問の価値は選択肢の質に完全に依存する。**

**悪い質問の例:**
```
どのアプローチを使用すべきですか？
A) 良いアプローチ
B) 悪いアプローチ
C) その他
```
問題点: 選択肢が具体的でない、トレードオフなし、コンテキストなし。

**良い質問の例:**
```
キャッシングにどのアプローチを使用すべきですか？

A) インメモリキャッシュ（例: Redis）
   - 利点: 速い（サブms レイテンシ）、シンプル
   - 欠点: 再起動時のデータ損失、メモリ制限
   - 最適: セッションデータ、一時的な状態

B) 分散キャッシュ（例: Memcached クラスター）
   - 利点: スケーラブル、インスタンス間で共有
   - 欠点: ネットワークレイテンシ、より複雑
   - 最適: マルチインスタンスデプロイ

C) データベース バックドキャッシュ
   - 利点: 永続的、データ損失なし
   - 欠点: 遅い（10-50ms レイテンシ）
   - 最適: 変更頻度の低いデータ
```
強み: 具体的な技術、明示的なトレードオフ、ユースケースガイダンス。

---

## 🛡️ スコープクリープの防止

### 実装中に新要件が出現した場合

**フロー:**
1. **認識**: "この新しい要件 [X] は、frozen requirement [Y] を変更するようです。"
2. **影響評価**: "これを実装すると [タイムライン/スコープ/アプローチ] に影響します。"
3. **明示的な再合意**: "frozen requirements を更新してプランを調整すべきか、次フェーズに延期すべきか？"
4. **変更を文書化**: タイムスタンプと理由とともに "Frozen Requirements" セクションを更新

**原則**: スコープ変更は許容されるが、暗黙のうちに吸収されるのではなく、明示的かつ合意が必要。

---

## 🎓 まとめ: なぜこのアプローチが機能するか

### 強み

1. **問いの標準化**: トレードオフ付きの選択肢（A, B, C）によりユーザーの意思決定疲労を削減
2. **ビジネス価値のリンク**: 「エンジニアリングのためのエンジニアリング」を防ぐ
3. **多ステークホルダー視点**: 「うまく動くが誰も望まない機能」のリスクを削減
4. **制約駆動設計**: シニアエンジニア/アーキテクトの思考プロセスを反映

### 注意すべき課題

1. **ユーザー疲労**: 重いプロセスは単純なタスクを圧倒する可能性がある
2. **質問の質**: 悪い選択肢は節約よりも多くの作業を生み出す
3. **スコープクリープ**: 要件が変更された場合、明示的な再合意が必要

---

**このアプローチは、AIを「コード生成機」から「テックリード/PM副操縦士」へ変換します。**
