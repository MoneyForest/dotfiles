---
name: self-review
description: Self-review for PRs from a teammate perspective. Use after creating a PR to check code quality, security, performance, tests, and design with fresh eyes.
---

# Self-Review Skill

PR作成後に、チームメンバーの視点で客観的にセルフレビューを行う。

> **視点**: 他の開発者がこのコードを読んだとき、理解しやすいか？保守しやすいか？

## When to Activate

- PR を作成した後のセルフチェック
- マージ前の最終確認
- `/self-review` で明示的に呼び出し

## Review Process

### Step 1: 差分の取得

```bash
# 現在のブランチのベースからの差分を取得
git diff $(git merge-base HEAD main)..HEAD

# または PR 番号がわかっている場合
gh pr diff <pr-number>
```

### Step 2: レビュー観点

以下の観点で差分を確認し、**問題点のみ**を指摘する。

---

## 1. コード品質

チームメンバーが読んだとき、すぐに理解できるか？

### 確認観点

| 観点 | 問題例 |
|------|--------|
| 命名 | 意図が伝わらない変数名・関数名 |
| 関数サイズ | 長すぎる関数（目安: 50行超） |
| ネスト | 深すぎる条件分岐（目安: 3段超） |
| コメント | 嘘のコメント、古いコメント |
| DRY | 明らかなコード重複 |
| マジックナンバー | 意味不明な定数 |

### 指摘フォーマット

```
**[品質]** `path/to/file.go:123`
- 問題: 関数名 `doSomething` が何をするか不明
- 提案: `validateUserInput` など具体的な名前に
```

---

## 2. セキュリティ

脆弱性を生んでいないか？

### 確認観点

| 観点 | 問題例 |
|------|--------|
| 入力検証 | ユーザー入力の未検証 |
| 認証/認可 | 権限チェック漏れ |
| SQLインジェクション | 文字列結合でのSQL組み立て |
| XSS | 未エスケープの出力 |
| 機密情報 | ハードコードされた秘密情報 |
| ログ出力 | 機密情報のログ出力 |

### 指摘フォーマット

```
**[セキュリティ]** `path/to/file.go:45`
- 問題: ユーザー入力を直接SQLクエリに埋め込んでいる
- リスク: SQLインジェクション
- 提案: プリペアドステートメントを使用
```

---

## 3. パフォーマンス

明らかな性能問題はないか？

### 確認観点

| 観点 | 問題例 |
|------|--------|
| N+1 | ループ内でのDB/API呼び出し |
| 不要な処理 | 使われない計算、重複した処理 |
| メモリ | 大きなデータの不必要なコピー |
| 非同期 | ブロッキング処理の不適切な配置 |
| キャッシュ | 明らかにキャッシュすべき重い処理 |

### 指摘フォーマット

```
**[パフォーマンス]** `path/to/file.go:78`
- 問題: ループ内で毎回DBクエリを発行（N+1）
- 影響: データ量に比例してレイテンシ増加
- 提案: ループ前に一括取得してマップで保持
```

---

## 4. テスト

テストは十分か？

### 確認観点

| 観点 | 問題例 |
|------|--------|
| カバレッジ | 新規コードにテストがない |
| エッジケース | 境界値、エラーケースの未テスト |
| モック | 外部依存の未モック |
| アサーション | 不十分な検証 |

### 指摘フォーマット

```
**[テスト]** `path/to/file.go:100`
- 問題: エラーケースのテストがない
- 提案: `TestXxx_Error` を追加
```

---

## 5. 設計/アーキテクチャ

設計原則に反していないか？

### 確認観点

| 観点 | 問題例 |
|------|--------|
| 単一責任 | 複数の責務を持つクラス/関数 |
| 依存関係 | 循環依存、不適切なレイヤー間依存 |
| 抽象化 | 過剰または不足した抽象化 |
| 副作用 | 予期しない状態変更 |

### 指摘フォーマット

```
**[設計]** `path/to/file.go`
- 問題: Repository層からHTTPリクエストを発行している
- 原則違反: レイヤー間の責務境界
- 提案: Gateway層に移動
```

---

## Output Format

問題が見つかった場合のみ、以下の形式で出力する。

```markdown
## Self-Review Results

### 問題点

**[カテゴリ]** `file:line`
- 問題: 具体的な問題の説明
- 提案: 改善案（あれば）

**[カテゴリ]** `file:line`
- 問題: ...

---

### サマリー

- 品質: X件
- セキュリティ: X件
- パフォーマンス: X件
- テスト: X件
- 設計: X件

**総評**: 一言コメント
```

問題がない場合：

```markdown
## Self-Review Results

問題点は見つかりませんでした。
```

## Notes

- 些細な指摘（typo、フォーマット）はリンターに任せる
- 主観的な好みは指摘しない
- 「こうした方がいい」ではなく「こうしないと問題がある」に焦点
- 褒めポイントは書かない（問題点のみ）
